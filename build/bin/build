#!/usr/bin/env bash

WP_VERSIONS=${1:-""}
WP_LATEST_VERSION=${2:-""}
TARGET_PLATFORMS="linux/amd64,linux/armhf,linux/aarch64"

CACHE_DIR="/tmp/.buildx-cache"

if [ -z "${WP_VERSIONS}" ]; then
  echo "Error: WP_VERSIONS is null"
  exit 1
fi

docker buildx create --use --name build --node build --driver-opt network=host

# Loop through requested versions
for TARGET_VERSION in ${WP_VERSIONS}; do
  echo "> Building WordPress ${TARGET_VERSION}"

  IMAGE_TAGS="--tag nlss/wordpress:${TARGET_VERSION}"

  if [ "${TARGET_VERSION}" = "${WP_LATEST_VERSION}" ]; then
    IMAGE_TAGS="${IMAGE_TAGS} --tag nlss/wordpress:latest"
  fi

  docker buildx build . \
    --pull \
    --push \
    --cache-from "type=local,src=${CACHE_DIR}" \
    --cache-to "type=local,dest=${CACHE_DIR},mode=max" \
    --build-arg "WP_VERSION=${TARGET_VERSION}" \
    --platform "${TARGET_PLATFORMS}" \
    ${IMAGE_TAGS[@]} &

  sleep 2
done
